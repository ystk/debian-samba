From 2e94b6ec10f1d15e24867bab3063bb85f173406a Mon Sep 17 00:00:00 2001
From: Jeremy Allison <jra@samba.org>
Date: Thu, 9 Jul 2015 10:58:11 -0700
Subject: [PATCH] CVE-2015-5252: s3: smbd: Fix symlink verification (file
 access outside the share).

Ensure matching component ends in '/' or '\0'.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=11395

Signed-off-by: Jeremy Allison <jra@samba.org>
Reviewed-by: Volker Lendecke <vl@samba.org>
Reviewed-by: Santiago R.R <santiagorr@riseup.net>
---
 source3/smbd/vfs.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

Index: samba/source3/smbd/vfs.c
===================================================================
--- samba.orig/source3/smbd/vfs.c
+++ samba/source3/smbd/vfs.c
@@ -949,6 +949,8 @@ NTSTATUS check_reduced_name(connection_s
 	/* Check for widelinks allowed. */
 	if (!lp_widelinks(SNUM(conn))) {
 		    const char *conn_rootdir;
+            size_t rootdir_len;
+            bool matched;
 
 		    conn_rootdir = SMB_VFS_CONNECTPATH(conn, fname);
 		    if (conn_rootdir == NULL) {
@@ -960,8 +962,11 @@ NTSTATUS check_reduced_name(connection_s
 			    return NT_STATUS_ACCESS_DENIED;
 		    }
 
-		    if (strncmp(conn_rootdir, resolved_name,
-				strlen(conn_rootdir)) != 0) {
+            rootdir_len = strlen(conn_rootdir);
+            matched = (strncmp(conn_rootdir, resolved_name,
+                    rootdir_len) == 0);
+            if (!matched || (resolved_name[rootdir_len] != '/' &&
+                     resolved_name[rootdir_len] != '\0')) {
 			    DEBUG(2, ("check_reduced_name: Bad access "
 				      "attempt: %s is a symlink outside the "
 				      "share path\n", fname));
