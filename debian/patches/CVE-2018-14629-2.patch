--- a/source4/dns_server/dns_query.c
+++ b/source4/dns_server/dns_query.c
@@ -253,7 +253,8 @@
 static WERROR handle_question(struct dns_server *dns,
 			      TALLOC_CTX *mem_ctx,
 			      const struct dns_name_question *question,
-			      struct dns_res_rec **answers, uint16_t *ancount)
+			      struct dns_res_rec **answers, uint16_t *ancount,
+			      size_t cname_depth)
 {
 	struct dns_res_rec *ans = *answers;
 	WERROR werror, werror_return;
@@ -262,7 +263,7 @@
 	uint16_t rec_count, ai = *ancount;
 	struct ldb_dn *dn = NULL;
 
-	if (talloc_array_length(*answers) >= MAX_Q_RECURSION_DEPTH) {
+	if (cname_depth >= MAX_Q_RECURSION_DEPTH) {
 		return WERR_OK;
 	}
 
@@ -320,7 +321,7 @@
 				return WERR_NOMEM;
 			}
 			/* and then call the lookup again */
-			werror = handle_question(dns, mem_ctx, new_q, &ans, &ai);
+			werror = handle_question(dns, mem_ctx, new_q, &ans, &ai, cname_depth + 1);
 			if (!W_ERROR_IS_OK(werror)) {
 				return werror;
 			}
@@ -617,7 +618,8 @@
 
 		req_state->flags |= DNS_FLAG_AUTHORITATIVE;
 		err = handle_question(dns, state, &in->questions[0],
-				      &state->answers, &state->ancount);
+				      &state->answers, &state->ancount,
+				      0 /* cname_depth */);
 		if (tevent_req_werror(req, err)) {
 			return tevent_req_post(req, ev);
 		}
